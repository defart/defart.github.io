(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==='object'&&typeof module==='object')
module.exports=factory();else if(typeof define==='function'&&define.amd)
define([],factory);else if(typeof exports==='object')
exports.opsapiIframe=factory();else root.opsapiIframe=factory()})(this,function(){return(function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId]){return installedModules[moduleId].exports}
var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=!0;return module.exports}
__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){if(!__webpack_require__.o(exports,name)){Object.defineProperty(exports,name,{enumerable:!0,get:getter})}};__webpack_require__.r=function(exports){if(typeof Symbol!=='undefined'&&Symbol.toStringTag){Object.defineProperty(exports,Symbol.toStringTag,{value:'Module'})}
Object.defineProperty(exports,'__esModule',{value:!0})};__webpack_require__.t=function(value,mode){if(mode&1)value=__webpack_require__(value);if(mode&8)return value;if((mode&4)&&typeof value==='object'&&value&&value.__esModule)return value;var ns=Object.create(null);__webpack_require__.r(ns);Object.defineProperty(ns,'default',{enumerable:!0,value:value});if(mode&2&&typeof value!='string')for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function getDefault(){return module['default']}:function getModuleExports(){return module};__webpack_require__.d(getter,'a',getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";return __webpack_require__(__webpack_require__.s=0)})([(function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _provider__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1);__webpack_require__.d(__webpack_exports__,"Provider",function(){return _provider__WEBPACK_IMPORTED_MODULE_0__["default"]});var _client__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(3);__webpack_exports__["default"]=(_client__WEBPACK_IMPORTED_MODULE_1__["default"])}),(function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"default",function(){return Provider});var _iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2);class Provider{constructor(window,api,bundleUrl=null){this.sock=null;this.window=window;this.api=api;this.clientOrigin=this.parseOriginFromPluginUrl(bundleUrl||'');this.window.top.onmessage=(e)=>{if(e.origin!==this.clientOrigin){return}
try{const msg=JSON.parse(e.data);if(msg.action===_iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_0__.ISOCK_ACTION_CONNECT&&e.ports.length&&e.ports[0]){const pluginPort=e.ports[0];this.sock=new _iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_0__["default"](pluginPort,'PROVIDER');this.setup(this.sock);this.sock.send(Object.assign(Object.assign({},msg),{action:_iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_0__.ISOCK_ACTION_READY,payload:_iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_0__.ISOCK_ACTION_READY,status:200}))}}
catch(e){console.log("Unable to establish client connection: "+e.message)}}}
setup(socket){const syncApiHandler=(msg,reply)=>{reply(Object.assign(Object.assign({},msg),{payload:this.makeSyncCall(msg)}))};socket.on("getUserName",syncApiHandler);socket.on("getUser",syncApiHandler);socket.on("getPlugins",syncApiHandler);socket.on("getAccessToken",syncApiHandler);socket.on("call",(msg,reply)=>{this.makeProxyCall(msg).then(result=>reply(Object.assign(Object.assign({},msg),{payload:result}))).catch((e)=>reply(Object.assign(Object.assign({},msg),{payload:e.message,status:500})))})}
destroy(){var _a;(_a=this.sock)===null||_a===void 0?void 0:_a.destroy()}
makeProxyCall(m){const p=m.payload;return this.api.call(p.url,p.data||{},p.method,p.headers||{})}
makeSyncCall(m){let result=null;switch(m.action){case 'getUserName':result=this.api.getUserName();break;case 'getUser':result=this.api.getUser();break;case 'getPlugins':result=this.api.getPlugins();break;case 'getAccessToken':result=this.api.getAccessToken();break}
return result}
parseOriginFromPluginUrl(bundleUrl){const parts=bundleUrl.split('/');if(parts.length>=3){return parts[0]+'//'+parts[2]}
return''}}}),(function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"ISOCK_ACTION_READY",function(){return ISOCK_ACTION_READY});__webpack_require__.d(__webpack_exports__,"ISOCK_ACTION_CONNECT",function(){return ISOCK_ACTION_CONNECT});__webpack_require__.d(__webpack_exports__,"ISOCK_ACTION_MESSAGE_RECEIVED",function(){return ISOCK_ACTION_MESSAGE_RECEIVED});__webpack_require__.d(__webpack_exports__,"default",function(){return IframeSocket});const ISOCK_ACTION_READY="IframeSocket::ACTION::READY";const ISOCK_ACTION_CONNECT="IframeSocket::ACTION::CONNECT";const ISOCK_ACTION_MESSAGE_RECEIVED="IframeSocket::ACTION::MESSAGE_RECEIVED";class IframeSocket{constructor(port,name='default'){this.name='default';this.name=name;this.port=port;this.messageHandlers={};this.port.onmessage=this.onMessage.bind(this)}
on(action,handler){if(!this.messageHandlers.hasOwnProperty(action)){this.messageHandlers[action]=[]}
this.messageHandlers[action].push(handler)}
off(action,handler){if(this.messageHandlers.hasOwnProperty(action)&&undefined===handler){this.messageHandlers[action]=[]}
else if(this.messageHandlers.hasOwnProperty(action)){this.messageHandlers[action]=this.messageHandlers[action].filter(handlerFn=>handlerFn!==handler)}}
send(msg){this.port.postMessage(JSON.stringify(msg))}
destroy(){this.messageHandlers={};this.port.close()}
onMessage(e){try{const msg=JSON.parse(e.data);this.trigger(msg.action,msg)}
catch(e){console.log(this.name+" received invalid message:"+e.message,e);return}}
trigger(action,msg){if(this.messageHandlers.hasOwnProperty(ISOCK_ACTION_MESSAGE_RECEIVED)&&this.messageHandlers[ISOCK_ACTION_MESSAGE_RECEIVED].length){this.messageHandlers[ISOCK_ACTION_MESSAGE_RECEIVED].forEach(handler=>{handler(msg,(m)=>this.send(m))})}
if(this.messageHandlers.hasOwnProperty(action)&&this.messageHandlers[action].length){this.messageHandlers[action].forEach(handler=>{handler(msg,(m)=>this.send(m))})}}}}),(function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"default",function(){return Client});var uuid__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4);var uuid__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(uuid__WEBPACK_IMPORTED_MODULE_0__);var _iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2);const TIMEOUT_LIMIT=15000;class Client{constructor(portalUrl){this.portalUrl=portalUrl;this.promiseQueue={};this.channel=new MessageChannel();this.port=this.channel.port1;this.sock=new _iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_1__["default"](this.port,'CLIENT')}
init(){this.sock.on(_iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_1__.ISOCK_ACTION_MESSAGE_RECEIVED,this.onMessageReturn.bind(this));return new Promise((resolve,reject)=>{this.sock.on(_iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_1__.ISOCK_ACTION_READY,()=>resolve(this.getSdk()));window.top.postMessage(JSON.stringify({action:_iframe_sock_iframeSocket__WEBPACK_IMPORTED_MODULE_1__.ISOCK_ACTION_CONNECT}),this.portalUrl,[this.channel.port2]);setTimeout(()=>reject("CLIENT TIMED OUT WHILE ESTABLISHING CONNECTION"),TIMEOUT_LIMIT)})}
onMessageReturn(msg){if(this.promiseQueue.hasOwnProperty(msg.id)){this.promiseQueue[msg.id].resolve(msg);delete this.promiseQueue[msg.id]}}
send(action,payload=null){const id=uuid__WEBPACK_IMPORTED_MODULE_0___default()();const message={id,action,payload,created:new Date()};return new Promise((resolveFn,rejectFn)=>{this.promiseQueue[id]={resolve:resolveFn,reject:rejectFn};this.port.postMessage(JSON.stringify(message));setTimeout(()=>rejectFn(new Error('CLIENT TIMED OUT FOR MSG ID: '+id)),TIMEOUT_LIMIT)})}
getSdk(){return{getUserName:()=>this.send('getUserName'),getUser:()=>this.send('getUser'),getPlugins:()=>this.send('getPlugins'),getAccessToken:()=>this.send('getAccessToken'),call:(url,data,headers,method)=>{const message={url,data,headers:headers||{},method:method||"GET"};return this.send('call',message)}}}}}),(function(module,exports,__webpack_require__){var v1=__webpack_require__(5);var v4=__webpack_require__(8);var uuid=v4;uuid.v1=v1;uuid.v4=v4;module.exports=uuid}),(function(module,exports,__webpack_require__){var rng=__webpack_require__(6);var bytesToUuid=__webpack_require__(7);var _nodeId;var _clockseq;var _lastMSecs=0;var _lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var node=options.node||_nodeId;var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;if(node==null||clockseq==null){var seedBytes=rng();if(node==null){node=_nodeId=[seedBytes[0]|0x01,seedBytes[1],seedBytes[2],seedBytes[3],seedBytes[4],seedBytes[5]]}
if(clockseq==null){clockseq=_clockseq=(seedBytes[6]<<8|seedBytes[7])&0x3fff}}
var msecs=options.msecs!==undefined?options.msecs:new Date().getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=(msecs-_lastMSecs)+(nsecs-_lastNSecs)/10000;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&0x3fff}
if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}
if(nsecs>=10000){throw new Error('uuid.v1(): Can\'t create more than 10M uuids/sec')}
_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=12219292800000;var tl=((msecs&0xfffffff)*10000+nsecs)%0x100000000;b[i++]=tl>>>24&0xff;b[i++]=tl>>>16&0xff;b[i++]=tl>>>8&0xff;b[i++]=tl&0xff;var tmh=(msecs/0x100000000*10000)&0xfffffff;b[i++]=tmh>>>8&0xff;b[i++]=tmh&0xff;b[i++]=tmh>>>24&0xf|0x10;b[i++]=tmh>>>16&0xff;b[i++]=clockseq>>>8|0x80;b[i++]=clockseq&0xff;for(var n=0;n<6;++n){b[i+n]=node[n]}
return buf?buf:bytesToUuid(b)}
module.exports=v1}),(function(module,exports){var getRandomValues=(typeof(crypto)!='undefined'&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto))||(typeof(msCrypto)!='undefined'&&typeof window.msCrypto.getRandomValues=='function'&&msCrypto.getRandomValues.bind(msCrypto));if(getRandomValues){var rnds8=new Uint8Array(16);module.exports=function whatwgRNG(){getRandomValues(rnds8);return rnds8}}else{var rnds=new Array(16);module.exports=function mathRNG(){for(var i=0,r;i<16;i++){if((i&0x03)===0)r=Math.random()*0x100000000;rnds[i]=r>>>((i&0x03)<<3)&0xff}
return rnds}}}),(function(module,exports){var byteToHex=[];for(var i=0;i<256;++i){byteToHex[i]=(i+0x100).toString(16).substr(1)}
function bytesToUuid(buf,offset){var i=offset||0;var bth=byteToHex;return([bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],'-',bth[buf[i++]],bth[buf[i++]],'-',bth[buf[i++]],bth[buf[i++]],'-',bth[buf[i++]],bth[buf[i++]],'-',bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]]]).join('')}
module.exports=bytesToUuid}),(function(module,exports,__webpack_require__){var rng=__webpack_require__(6);var bytesToUuid=__webpack_require__(7);function v4(options,buf,offset){var i=buf&&offset||0;if(typeof(options)=='string'){buf=options==='binary'?new Array(16):null;options=null}
options=options||{};var rnds=options.random||(options.rng||rng)();rnds[6]=(rnds[6]&0x0f)|0x40;rnds[8]=(rnds[8]&0x3f)|0x80;if(buf){for(var ii=0;ii<16;++ii){buf[i+ii]=rnds[ii]}}
return buf||bytesToUuid(rnds)}
module.exports=v4})])["default"]})
